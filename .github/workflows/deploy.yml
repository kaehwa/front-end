name: Deploy Web to Azure VM

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: gaehwa-web

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install --force

      - name: Build Next.js
        run: npm run build -- --no-lint

      - name: Verify build output
        run: ls -la .next

      - name: Deploy to Azure VM via SCP
        run: |
          echo "Deploying to Azure VM..."
          scp -i ${{ secrets.AZURE_SSH_KEY }} -r \
            .next/* \
            public/* \
            package.json \
            package-lock.json \
            next.config.js \
            ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }}:/var/www/expogo

      - name: Reload nginx
        run: |
          ssh -i ${{ secrets.AZURE_SSH_KEY }} ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }} \
          "sudo systemctl reload nginx"
